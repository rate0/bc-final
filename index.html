<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Обмен цифровыми визитками</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
    }
    h1, h2 {
      color: #333;
    }
    .card-form input, .card-form button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      box-sizing: border-box;
    }
    .card {
      border: 1px solid #ddd;
      background: #fafafa;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
    }
  </style>

  <!-- Гарантированная загрузка ethers.js -->
  <script>
    function loadEthersJS() {
      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js";
        script.onload = () => {
          console.log("Ethers.js загружен!");
          resolve(window.ethers);
        };
        script.onerror = () => {
          console.error("Ошибка загрузки ethers.js");
          alert("Ошибка загрузки библиотеки ethers.js. Проверьте соединение.");
          reject(new Error("ethers.js не загрузился"));
        };
        document.head.appendChild(script);
      });
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>Обмен цифровыми визитками</h1>
    <div class="card-form">
      <h2>Создать новую визитку</h2>
      <input type="text" id="name" placeholder="Имя" required>
      <input type="email" id="email" placeholder="Email" required>
      <input type="text" id="phone" placeholder="Телефон" required>
      <input type="text" id="company" placeholder="Компания" required>
      <input type="text" id="position" placeholder="Должность" required>
      <button onclick="createCard()">Отправить</button>
    </div>
    <hr>
    <div class="card-list">
      <h2>Ваши визитки</h2>
      <div id="cards"></div>
    </div>
  </div>

  <!-- Основной скрипт -->
  <script>
    let provider, signer, contract;

    const contractAddress = "0x5Ce6757BD069FCF97833Ce1340EDbF0f60CB71E8";
    const contractABI = [
      "function createCard(string _name, string _email, string _phone, string _company, string _position) public",
      "function getOwnerCards(address _owner) public view returns (uint256[])",
      "function cards(uint256) public view returns (string name, string email, string phone, string company, string position, address owner, uint256 timestamp)"
    ];

    async function init() {
      try {
        // Загружаем ethers.js
        const ethers = await loadEthersJS();

        // Проверяем, установлен ли MetaMask
        if (typeof window.ethereum === "undefined") {
          alert("MetaMask не установлен. Установите расширение для использования приложения.");
          return;
        }

        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        contract = new ethers.Contract(contractAddress, contractABI, signer);

        console.log("MetaMask успешно подключён.");
        await loadCards();
      } catch (error) {
        console.error("Ошибка инициализации:", error);
        alert("Ошибка при инициализации. Проверьте консоль.");
      }
    }

    async function createCard() {
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const company = document.getElementById("company").value.trim();
      const position = document.getElementById("position").value.trim();

      if (!name || !email || !phone || !company || !position) {
        alert("Пожалуйста, заполните все поля.");
        return;
      }

      try {
        const tx = await contract.createCard(name, email, phone, company, position);
        await tx.wait();
        alert("Визитка успешно создана!");

        document.getElementById("name").value = "";
        document.getElementById("email").value = "";
        document.getElementById("phone").value = "";
        document.getElementById("company").value = "";
        document.getElementById("position").value = "";

        await loadCards();
      } catch (error) {
        console.error("Ошибка при создании визитки:", error);
        alert("Ошибка при создании визитки. Подробности в консоли.");
      }
    }

    async function loadCards() {
      const cardsDiv = document.getElementById("cards");
      cardsDiv.innerHTML = "";

      try {
        const userAddress = await signer.getAddress();
        const cardIds = await contract.getOwnerCards(userAddress);

        for (let i = 0; i < cardIds.length; i++) {
          const cardData = await contract.cards(cardIds[i]);

          const cardElement = document.createElement("div");
          cardElement.className = "card";
          cardElement.innerHTML = `
            <strong>Имя:</strong> ${cardData.name} <br>
            <strong>Email:</strong> ${cardData.email} <br>
            <strong>Телефон:</strong> ${cardData.phone} <br>
            <strong>Компания:</strong> ${cardData.company} <br>
            <strong>Должность:</strong> ${cardData.position} <br>
            <strong>Создана:</strong> ${new Date(cardData.timestamp * 1000).toLocaleString()} <br>
          `;

          cardsDiv.appendChild(cardElement);
        }
      } catch (error) {
        console.error("Ошибка при загрузке визиток:", error);
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
