<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Обмен цифровыми визитками</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
    }
    h1, h2 {
      color: #333;
    }
    .card-form input, .card-form button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      box-sizing: border-box;
    }
    .card {
      border: 1px solid #ddd;
      background: #fafafa;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Обмен цифровыми визитками</h1>
    <div class="card-form">
      <h2>Создать новую визитку</h2>
      <input type="text" id="name" placeholder="Имя" required>
      <input type="email" id="email" placeholder="Email" required>
      <input type="text" id="phone" placeholder="Телефон" required>
      <input type="text" id="company" placeholder="Компания" required>
      <input type="text" id="position" placeholder="Должность" required>
      <button onclick="createCard()">Отправить</button>
    </div>
    <hr>
    <div class="card-list">
      <h2>Ваши визитки</h2>
      <div id="cards"></div>
    </div>
  </div>
  
  <!-- Подключаем ethers.js из CDN (обязательно до вашего скрипта) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>

  <!-- Ваш скрипт для взаимодействия с контрактом -->
  <script>
    // Вставьте здесь адрес контракта, скопированный после деплоя
    const contractAddress = "0x5Ce6757BD069FCF97833Ce1340EDbF0f60CB71E8"; // <-- СЮДА ВСТАВЬТЕ АДРЕС

    // ABI (описание функций) должно соответствовать коду контракта
    const contractABI = [
      "function createCard(string _name, string _email, string _phone, string _company, string _position) public",
      "function getOwnerCards(address _owner) public view returns (uint256[])",
      "function cards(uint256) public view returns (string name, string email, string phone, string company, string position, address owner, uint256 timestamp)"
    ];

    let provider, signer, contract;

    // Функция инициализации приложения
    async function init() {
      // Проверяем, установлен ли MetaMask (window.ethereum)
      if (typeof window.ethereum !== 'undefined') {
        try {
          // Создаём провайдер на базе MetaMask
          provider = new ethers.providers.Web3Provider(window.ethereum);
          // Запрашиваем доступ к аккаунтам
          await provider.send("eth_requestAccounts", []);
          // Получаем объект signer для подписания транзакций
          signer = provider.getSigner();

          // Инициализируем контракт
          contract = new ethers.Contract(contractAddress, contractABI, signer);

          // Загружаем существующие визитки
          await loadCards();
        } catch (error) {
          console.error("Ошибка при инициализации MetaMask:", error);
          alert("Ошибка при подключении MetaMask. Проверьте консоль.");
        }
      } else {
        alert("MetaMask не установлен. Установите расширение, чтобы использовать приложение.");
      }
    }

    // Функция для создания новой визитки
    async function createCard() {
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const company = document.getElementById("company").value.trim();
      const position = document.getElementById("position").value.trim();

      if (!name || !email || !phone || !company || !position) {
        alert("Пожалуйста, заполните все поля.");
        return;
      }

      try {
        // Вызываем метод createCard на смарт-контракте
        const tx = await contract.createCard(name, email, phone, company, position);
        await tx.wait(); // Ждём подтверждения транзакции
        alert("Визитка успешно создана!");

        // Очищаем поля формы
        document.getElementById("name").value = "";
        document.getElementById("email").value = "";
        document.getElementById("phone").value = "";
        document.getElementById("company").value = "";
        document.getElementById("position").value = "";

        // Обновляем список визиток
        await loadCards();
      } catch (error) {
        console.error("Ошибка при создании визитки:", error);
        alert("Ошибка при создании визитки. Подробности в консоли.");
      }
    }

    // Функция для загрузки и отображения визиток пользователя
    async function loadCards() {
      const cardsDiv = document.getElementById("cards");
      cardsDiv.innerHTML = ""; // Очищаем предыдущий вывод

      try {
        // Узнаём адрес кошелька пользователя
        const userAddress = await signer.getAddress();
        // Получаем список ID визиток, принадлежащих данному адресу
        const cardIds = await contract.getOwnerCards(userAddress);

        for (let i = 0; i < cardIds.length; i++) {
          const cardData = await contract.cards(cardIds[i]);

          // Создаём элемент для отображения визитки
          const cardElement = document.createElement("div");
          cardElement.className = "card";
          cardElement.innerHTML = `
            <strong>Имя:</strong> ${cardData.name} <br>
            <strong>Email:</strong> ${cardData.email} <br>
            <strong>Телефон:</strong> ${cardData.phone} <br>
            <strong>Компания:</strong> ${cardData.company} <br>
            <strong>Должность:</strong> ${cardData.position} <br>
            <strong>Создана:</strong> ${new Date(cardData.timestamp * 1000).toLocaleString()} <br>
          `;

          cardsDiv.appendChild(cardElement);
        }
      } catch (error) {
        console.error("Ошибка при загрузке визиток:", error);
      }
    }

    // Запускаем init при загрузке страницы
    window.addEventListener("load", init);
  </script>
</body>
</html>
